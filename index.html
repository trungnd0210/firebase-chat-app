<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thread</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuration for Tailwind dark mode and custom colors
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': { '50': '#f0f9ff', '100': '#e0f2fe', '200': '#bae6fd', '300': '#7dd3fc', '400': '#38bdf8', '500': '#0ea5e9', '600': '#0284c7', '700': '#0369a1', '800': '#075985', '900': '#0c4a6e' },
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Favicon -->
    <link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .scrollable-content::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-content::-webkit-scrollbar-track { background: transparent; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .dark .scrollable-content::-webkit-scrollbar-thumb { background: #4b5563; }
        .message.fading-out { opacity: 0; transform: scale(0.9); transition: all 0.3s ease-in-out; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease infinite; }
        .spinner-small { border: 2px solid rgba(255, 255, 255, 0.3); width: 20px; height: 20px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes bounce-in { 0% { transform: scale(0.8); opacity: 0; } 80% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .reaction-chip.user-reacted { background-color: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
        .dark .reaction-chip.user-reacted { background-color: #075985; color: #e0f2fe; border-color: #0284c7; }
        .thread-container {
            padding-left: 2.5rem; /* 40px */
            border-left: 2px solid #e5e7eb;
            margin-left: 0.75rem; /* 12px */
        }
        .dark .thread-container {
            border-left-color: #374151;
        }
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        .group:hover .message-actions {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-950 flex items-center justify-center h-screen transition-colors duration-300 text-gray-800 dark:text-gray-200">

    <div id="app-container" class="w-full h-screen flex flex-col bg-gray-50 dark:bg-gray-900">

        <!-- Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full bg-gray-50 dark:bg-gray-900 p-8 text-center transition-colors duration-300">
            <div class="mb-8 text-6xl">üí¨</div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white mb-2">Welcome to Pro Chat</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-10">The modern, fast, and fun way to connect.</p>
            <button id="login-button" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-primary-500/20 flex items-center justify-center transition-all duration-300 transform hover:scale-105 w-64">
                <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.75 8.36,4.73 12.19,4.73C14.03,4.73 15.6,5.36 16.81,6.45L18.83,4.55C17.02,2.77 14.81,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.2 6.42,22 12.19,22C17.6,22 21.54,18.33 21.54,12.29C21.54,11.8 21.48,11.45 21.35,11.1Z"/></svg>
                <span>Sign in with Google</span>
            </button>
        </div>
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="hidden flex-col items-center justify-center h-full bg-gray-50 dark:bg-gray-900 p-8 text-center transition-colors duration-300">
            <div class="spinner"></div>
            <p class="text-gray-500 dark:text-gray-400 mt-4">Connecting...</p>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden flex-1 flex-col bg-gray-100 dark:bg-gray-900">
            <header class="bg-white dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-700/50 p-4 flex justify-between items-center shadow-sm">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white">Rooms</h1>
                <div class="flex items-center gap-2 md:gap-4">
                    <span id="lobby-user-name" class="font-semibold text-gray-700 dark:text-gray-200 hidden md:block"></span>
                    <button id="notification-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition"></button>
                    <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition"></button>
                    <button id="create-room-button" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg text-sm md:text-base transition-all duration-300 transform hover:scale-105">Create Room</button>
                    <button id="lobby-logout-button" class="bg-gray-200 dark:bg-gray-700 hover:bg-red-500 dark:hover:bg-red-600 hover:text-white dark:text-gray-300 font-semibold py-2 px-3 rounded-lg text-sm transition">Logout</button>
                </div>
            </header>
            <main id="room-list-container" class="flex-1 p-4 md:p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 overflow-y-auto scrollable-content"></main>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="hidden flex flex-col h-full bg-gray-100 dark:bg-gray-900">
            <!-- Header: This part will be fixed -->
            <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700/80 p-3 md:p-4 flex justify-between items-center shadow-sm shrink-0">
                <div class="flex items-center flex-1 min-w-0">
                    <button id="back-to-lobby-button" class="mr-2 md:mr-4 p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div class="flex items-center min-w-0">
                        <h1 id="room-name" class="text-lg md:text-xl font-bold text-gray-800 dark:text-white mr-2 truncate"></h1>
                        <button id="edit-room-name-button" class="p-1 rounded-full text-gray-400 hover:text-gray-700 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 transition shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                        </button>
                    </div>
                    <button id="manage-requests-button" class="hidden ml-2 md:ml-4 bg-primary-100 text-primary-700 text-xs font-bold py-1 px-2 md:px-3 rounded-full flex items-center gap-2 shrink-0 hover:bg-primary-200 transition">
                        <span class="hidden md:inline">Manage Requests</span>
                        <span class="md:hidden">Reqs</span>
                        <span id="requests-count" class="bg-primary-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">0</span>
                    </button>
                </div>
                <div class="flex items-center shrink-0 gap-2">
                    <div class="flex items-center gap-3 border-r border-gray-200 dark:border-gray-700 pr-3">
                        <button id="translate-toggle" class="px-3 py-1 text-sm font-bold rounded-full transition"></button>
                        <div class="relative">
                            <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="Avatar">
                            <button id="edit-user-profile-button" class="absolute -bottom-1 -right-1 p-1 bg-white dark:bg-gray-700 rounded-full text-gray-500 hover:text-primary-600 shadow-md border dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 transition shrink-0">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                        </div>
                        <span id="user-name" class="hidden lg:inline font-semibold text-gray-700 dark:text-gray-200"></span>
                    </div>
                </div>
            </header>

            <!-- Messages Container: This part will scroll -->
            <main id="messages-container" class="flex-1 p-4 lg:p-6 overflow-y-auto space-y-6 scrollable-content min-h-0">
                 <div id="messages-loader" class="hidden justify-center py-4"><div class="spinner"></div></div>
            </main>
            
            <!-- Message Input Form: This part will be fixed -->
            <footer class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-3 md:p-4 border-t border-gray-200 dark:border-gray-700/80 shrink-0">
                <div id="typing-indicator" class="px-1 text-sm italic text-gray-500 dark:text-gray-400"></div>
                <form id="message-form" class="flex items-start space-x-2 md:space-x-3">
                    <img id="main-reply-avatar" class="w-8 h-8 rounded-full" src="" alt="Your avatar">
                    <div class="relative flex-1 flex items-center bg-gray-100 dark:bg-gray-700 rounded-2xl border border-gray-200 dark:border-gray-600 focus-within:ring-2 focus-within:ring-primary-500">
                        <div class="absolute left-2 top-1/2 -translate-y-1/2 flex items-center">
                            <input type="file" id="image-input" accept="image/*" class="hidden">
                            <button type="button" id="image-upload-button" class="p-2 rounded-full text-gray-500 hover:text-primary-600 hover:bg-gray-200 dark:hover:bg-gray-600 transition" title="Send an image">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01"></path></svg>
                            </button>
                            <button type="button" id="giphy-button" class="p-2 rounded-full text-gray-500 hover:text-primary-600 hover:bg-gray-200 dark:hover:bg-gray-600 transition" title="Send a GIF">
                                <span class="text-sm font-bold">GIF</span>
                            </button>
                        </div>
                        <textarea id="message-input" placeholder="Start a new thread..." autocomplete="off" class="w-full p-2 pl-24 bg-transparent text-gray-800 dark:text-white focus:outline-none resize-none" rows="1"></textarea>
                        <div class="flex items-center pr-2">
                            <select id="timer-select" class="p-2 border-none bg-transparent text-gray-500 dark:text-gray-400 focus:outline-none focus:ring-0">
                                <option value="0">‚è±Ô∏è</option>
                                <option value="5000">5s</option>
                                <option value="30000">30s</option>
                                <option value="60000">1m</option>
                            </select>
                            <button id="submit-button" type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold p-2 rounded-full shadow-md shadow-primary-500/20 transition-all duration-300 flex items-center justify-center transform hover:scale-110 disabled:opacity-50 disabled:scale-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                        </div>
                    </div>
                </form>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, Timestamp, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc, writeBatch, getDocs, limit, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6hlFCJlc6hhQKYWLWNAahO6N3GovNS4M",
            authDomain: "temp-chat-bce85.firebaseapp.com",
            projectId: "temp-chat-bce85",
            storageBucket: "temp-chat-bce85.appspot.com",
            messagingSenderId: "166577116690",
            appId: "1:166577116690:web:ab33d857acfbf03dca6acb"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        setLogLevel('debug');

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentRoomId = null;
        let unsubscribeMessages = null;
        let unsubscribeRoom = null;
        let unsubscribeRoomsList = null;
        let unsubscribeTyping = null;
        let messageCheckerInterval = null;
        let isTranslateEnabled = localStorage.getItem('translateEnabled') === 'true';
        let areNotificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
        const originalTitle = document.title;
        const GIPHY_API_KEY = 'DKZ8cJ3YSig3vMJssLkKtxfpTWJsxHrV'; 
        const IMGBB_API_KEY = '7543a18b52116a7616226087a6d7b8f3';
        const AVAILABLE_REACTIONS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'ü§î'];
        
        let messages = [];
        let lastVisibleMessageDoc = null;
        let isLoadingMoreMessages = false;
        let allMessagesLoaded = false;
        const MESSAGES_PER_PAGE = 50;
        const OLDER_MESSAGES_PER_PAGE = 15; // New constant for pagination

        // --- DOM ELEMENTS CACHE ---
        const dom = {
            html: document.documentElement,
            screens: {
                login: document.getElementById('login-screen'),
                loading: document.getElementById('loading-screen'),
                lobby: document.getElementById('lobby-screen'),
                chat: document.getElementById('chat-screen'),
            },
            loginButton: document.getElementById('login-button'),
            lobbyLogoutButton: document.getElementById('lobby-logout-button'),
            messageForm: document.getElementById('message-form'),
            messagesContainer: document.getElementById('messages-container'),
            messagesLoader: document.getElementById('messages-loader'),
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            lobbyUserName: document.getElementById('lobby-user-name'),
            timerSelect: document.getElementById('timer-select'),
            roomNameElement: document.getElementById('room-name'),
            modalContainer: document.getElementById('modal-container'),
            roomListContainer: document.getElementById('room-list-container'),
            createRoomButton: document.getElementById('create-room-button'),
            backToLobbyButton: document.getElementById('back-to-lobby-button'),
            editRoomNameButton: document.getElementById('edit-room-name-button'),
            editUserProfileButton: document.getElementById('edit-user-profile-button'),
            manageRequestsButton: document.getElementById('manage-requests-button'),
            requestsCount: document.getElementById('requests-count'),
            favicon: document.getElementById('favicon'),
            messageInput: document.getElementById('message-input'),
            themeToggle: document.getElementById('theme-toggle'),
            notificationToggle: document.getElementById('notification-toggle'),
            typingIndicator: document.getElementById('typing-indicator'),
            giphyButton: document.getElementById('giphy-button'),
            imageUploadButton: document.getElementById('image-upload-button'),
            imageInput: document.getElementById('image-input'),
            translateToggle: document.getElementById('translate-toggle'),
            submitButton: document.getElementById('submit-button'),
            mainReplyAvatar: document.getElementById('main-reply-avatar'),
        };

        const defaultFavicon = "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>";
        const newMesageFavicon = "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>";

        // --- UTILITY & UI FUNCTIONS ---
        function showScreen(screenName) {
            Object.values(dom.screens).forEach(screen => screen.classList.add('hidden'));
            dom.screens[screenName].classList.remove('hidden');
            dom.screens[screenName].classList.add('flex');
        }

        function createModal(id, title, content, saveButtonText = 'Save') {
            const existingModal = document.getElementById(id);
            if(existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = id;
            modal.className = "hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-bounce-in";
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 dark:text-white">${title}</h2>
                    ${content}
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="modal-cancel bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                        <button class="modal-save bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg transition">${saveButtonText}</button>
                    </div>
                </div>`;
            dom.modalContainer.appendChild(modal);
            modal.querySelector('.modal-cancel').addEventListener('click', () => modal.remove());
            return modal;
        }
        
        function showImageModal(imageUrl) {
            const modal = createModal('image-viewer-modal', '', `<img src="${imageUrl}" alt="Full size image" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl">`, '');
            modal.querySelector('.modal-save').style.display = 'none';
            modal.querySelector('.modal-cancel').textContent = 'Close';
            modal.querySelector('h2').style.display = 'none';
            modal.classList.remove('hidden');
        }

        function showErrorModal(message) {
            const content = `<p class="text-gray-600 dark:text-gray-300">${message}</p>`;
            const modal = createModal('error-modal', 'Translation Error', content, 'OK');
            modal.querySelector('.modal-save').addEventListener('click', () => modal.remove());
            modal.querySelector('.modal-cancel').style.display = 'none';
            modal.classList.remove('hidden');
        }
        
        function cleanupListeners() {
            if (unsubscribeRoomsList) unsubscribeRoomsList();
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeTyping) unsubscribeTyping();
            if (messageCheckerInterval) clearInterval(messageCheckerInterval);
        }

        function updateThemeIcon() {
            if (dom.html.classList.contains('dark')) {
                dom.themeToggle.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            } else {
                dom.themeToggle.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
            }
        }

        // --- USER PROFILE & AVATAR LOGIC ---
        function getEffectivePhotoURL(user) {
            if (!user) return `https://ui-avatars.com/api/?name=A&background=random`;
            const preference = localStorage.getItem(`avatarPreference_${user.uid}`);
            if (preference === 'anonymous') {
                return `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'A')}&background=random`;
            }
            return user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'A')}&background=random`;
        }

        function updateUserUI() {
            if (!currentUser) return;
            const photoURL = getEffectivePhotoURL(currentUser);
            dom.userAvatar.src = photoURL;
            dom.mainReplyAvatar.src = photoURL;
            dom.userName.textContent = currentUser.displayName || 'Anonymous User';
            dom.lobbyUserName.textContent = currentUser.displayName;
        }

        function showEditProfileModal() {
            const currentPreference = localStorage.getItem(`avatarPreference_${currentUser.uid}`) || 'google';
            const content = `
                <div class="space-y-4">
                    <div>
                        <label for="new-user-name-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Display Name</label>
                        <input id="new-user-name-input" type="text" value="${currentUser.displayName}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Avatar</label>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                <input type="radio" name="avatar-option" value="google" class="h-4 w-4 text-primary-600 border-gray-300 focus:ring-primary-500" ${currentPreference === 'google' ? 'checked' : ''}>
                                <span class="ml-3 text-sm text-gray-800 dark:text-gray-200">Use Google Photo</span>
                                <img src="${currentUser.photoURL}" class="w-8 h-8 rounded-full ml-auto">
                            </label>
                            <label class="flex items-center p-3 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                <input type="radio" name="avatar-option" value="anonymous" class="h-4 w-4 text-primary-600 border-gray-300 focus:ring-primary-500" ${currentPreference === 'anonymous' ? 'checked' : ''}>
                                <span class="ml-3 text-sm text-gray-800 dark:text-gray-200">Use Anonymous Avatar</span>
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || 'A')}&background=random" class="w-8 h-8 rounded-full ml-auto">
                            </label>
                        </div>
                    </div>
                </div>
            `;
            const modal = createModal('user-profile-modal', 'Edit Profile', content);
            modal.querySelector('.modal-save').addEventListener('click', async () => {
                const newName = modal.querySelector('#new-user-name-input').value.trim();
                const newAvatarPreference = modal.querySelector('input[name="avatar-option"]:checked').value;

                if (newName && newName !== currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    await auth.currentUser.reload();
                    currentUser = auth.currentUser;
                }

                localStorage.setItem(`avatarPreference_${currentUser.uid}`, newAvatarPreference);
                
                updateUserUI();
                modal.remove();
            });
            modal.classList.remove('hidden');
        }

        // --- TRANSLATION LOGIC ---
        async function translateText(textToTranslate) {
            const apiKey = "AIzaSyBNKU6ZzXgtarPkW-ZWuEoNcO6rWvVqwl8";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const prompt = `Translate the following text to English. Provide only the translated text, without any introductory phrases: "${textToTranslate}"`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text.trim();
                throw new Error("Could not parse translation from API response.");
            } catch (error) {
                console.error("Error translating text:", error);
                showErrorModal(`Sorry, the translation service is currently unavailable. The original message will be sent.`);
                throw error;
            }
        }
        
        function updateTranslateButton() {
            if (isTranslateEnabled) {
                dom.translateToggle.textContent = 'EN';
                dom.translateToggle.title = 'Translation to English is ON';
                dom.translateToggle.classList.add('bg-green-500', 'text-white');
                dom.translateToggle.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            } else {
                dom.translateToggle.textContent = 'VN';
                dom.translateToggle.title = 'Translation is OFF (Vietnamese)';
                dom.translateToggle.classList.remove('bg-green-500', 'text-white');
                dom.translateToggle.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            }
        }

        // --- NOTIFICATION LOGIC ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) return;
            if (Notification.permission === "default") Notification.requestPermission();
        }

        function showNotification(title, body) {
            if (!areNotificationsEnabled || !("Notification" in window)) return;
            if (Notification.permission === "granted" && document.hidden) {
                new Notification(title, { body: body, icon: defaultFavicon });
            }
        }
        
        function updateNotificationToggleButton() {
            if (areNotificationsEnabled) {
                dom.notificationToggle.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>`;
                dom.notificationToggle.title = "Notifications are ON";
            } else {
                dom.notificationToggle.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-4-5.659m-4 0a6 6 0 00-4 5.659v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>`;
                dom.notificationToggle.title = "Notifications are OFF";
            }
        }

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();
        onAuthStateChanged(auth, (user) => {
            cleanupListeners();
            if (user) {
                currentUser = user;
                updateUserUI();
                showLobby();
            } else {
                currentUser = null;
                dom.modalContainer.innerHTML = ''; 
                showScreen('login');
            }
        });

        // --- LOBBY LOGIC ---
        function showLobby() {
            currentRoomId = null;
            showScreen('lobby');
            cleanupListeners();
            
            dom.lobbyUserName.textContent = currentUser.displayName;

            const roomsQuery = query(collection(db, 'rooms'), orderBy('name'));
            unsubscribeRoomsList = onSnapshot(roomsQuery, (snapshot) => {
                dom.roomListContainer.innerHTML = snapshot.docs.map(doc => {
                    const room = doc.data();
                    const id = doc.id;
                    const isAdmin = room.admin === currentUser.uid;
                    const isMember = Array.isArray(room.members) && room.members.includes(currentUser.uid);
                    const isPending = Array.isArray(room.pendingRequests) && room.pendingRequests.some(req => req.uid === currentUser.uid);

                    let actionButtons = '';
                    if (isAdmin || isMember) {
                        actionButtons = `<button class="enter-room-btn w-full bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition" data-id="${id}">Enter</button>`;
                    } else if (isPending) {
                        actionButtons = `<button class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg cursor-not-allowed text-sm font-semibold" disabled>Pending</button>`;
                    } else {
                        actionButtons = `<button class="request-join-btn w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition" data-id="${id}">Request</button>`;
                    }

                    const deleteButton = isAdmin ? `<button class="delete-room-btn absolute top-2 right-2 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-100 dark:hover:bg-gray-700 rounded-full transition" data-id="${id}" data-name="${room.name}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>` : '';

                    return `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 flex flex-col justify-between relative transform hover:-translate-y-1">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-white truncate pr-8">${room.name}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${room.members?.length || 0} members</p>
                            </div>
                            <div class="mt-4">${actionButtons}</div>
                            ${deleteButton}
                        </div>`;
                }).join('');
            });
        }

        // --- ROOM MANAGEMENT ---
        async function deleteRoom(roomId) {
            const messagesRef = collection(db, 'rooms', roomId, 'messages');
            const messagesSnapshot = await getDocs(messagesRef);
            const batch = writeBatch(db);
            messagesSnapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            await deleteDoc(doc(db, 'rooms', roomId));
        }

        function enterRoom(roomId) {
            currentRoomId = roomId;
            showScreen('chat');
            cleanupListeners(); 
            requestNotificationPermission();
            
            // Reset state for the new room
            messages = [];
            lastVisibleMessageDoc = null;
            isLoadingMoreMessages = false;
            allMessagesLoaded = false;
            dom.messagesContainer.innerHTML = '';
            dom.messagesContainer.prepend(dom.messagesLoader);

            const roomRef = doc(db, 'rooms', currentRoomId);
            unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (!docSnap.exists()) return showLobby();
                const roomData = docSnap.data();
                const isAdmin = roomData.admin === currentUser.uid;
                
                dom.roomNameElement.textContent = roomData.name;
                updateUserUI();

                dom.manageRequestsButton.classList.toggle('hidden', !isAdmin);
                dom.editRoomNameButton.classList.toggle('hidden', !isAdmin);
                if(isAdmin) dom.requestsCount.textContent = (roomData.pendingRequests || []).length;
            });
            
            updateTranslateButton();
            listenForLatestMessages(roomId); 
            messageCheckerInterval = setInterval(() => checkExpiredMessages(roomId), 1000);
        }

        // --- MESSAGES & THREADS LOGIC (WITH LAZY LOADING) ---
        
        // --- REVISED: UNIFIED REAL-TIME LISTENER ---
        function listenForLatestMessages(roomId) {
            const messagesCol = collection(db, 'rooms', roomId, 'messages');
            const q = query(messagesCol, orderBy("createdAt", "desc"), limit(MESSAGES_PER_PAGE));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const lastKnownMessageTime = messages.length > 0 ? messages[messages.length - 1].createdAt?.toMillis() : 0;
                
                const latestMessagesBatch = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Use a Map to merge existing messages with the latest batch, preventing duplicates.
                const messageMap = new Map();
                messages.forEach(msg => messageMap.set(msg.id, msg));
                latestMessagesBatch.forEach(msg => messageMap.set(msg.id, msg));
                
                const newMessages = Array.from(messageMap.values());
                newMessages.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis());
                messages = newMessages;

                if (snapshot.docs.length > 0) {
                    lastVisibleMessageDoc = snapshot.docs[snapshot.docs.length - 1];
                }
                
                allMessagesLoaded = snapshot.docs.length < MESSAGES_PER_PAGE;

                const isScrolledToBottom = dom.messagesContainer.scrollHeight - dom.messagesContainer.clientHeight <= dom.messagesContainer.scrollTop + 150;
                const isInitialLoad = dom.messagesContainer.children.length <= 1;
                
                renderThreads(messages);
                
                if (isInitialLoad || isScrolledToBottom) {
                    dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
                }

                // Handle notifications for new messages
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const newMessageData = change.doc.data();
                        if (newMessageData.createdAt?.toMillis() > lastKnownMessageTime) {
                            if (newMessageData.uid !== currentUser.uid) {
                                showNotification('System', 'System notification');
                            }
                        }
                    }
                });
            });
        }
        
        // --- REVISED: loadMoreMessages ---
        async function loadMoreMessages(roomId) {
            if (isLoadingMoreMessages || allMessagesLoaded) return;

            isLoadingMoreMessages = true;
            dom.messagesContainer.prepend(dom.messagesLoader);
            dom.messagesLoader.classList.remove('hidden');
            dom.messagesLoader.classList.add('flex');

            const messagesCol = collection(db, 'rooms', roomId, 'messages');
            const q = query(messagesCol, orderBy("createdAt", "desc"), startAfter(lastVisibleMessageDoc), limit(OLDER_MESSAGES_PER_PAGE));
            
            const querySnapshot = await getDocs(q);
            const oldScrollHeight = dom.messagesContainer.scrollHeight;

            dom.messagesLoader.classList.add('hidden');

            if (querySnapshot.empty) {
                allMessagesLoaded = true;
                isLoadingMoreMessages = false;
                return;
            }

            lastVisibleMessageDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
            
            const oldMessagesBatch = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const messageMap = new Map();
            oldMessagesBatch.forEach(msg => messageMap.set(msg.id, msg));
            messages.forEach(msg => messageMap.set(msg.id, msg));

            const newMessages = Array.from(messageMap.values());
            newMessages.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis());
            messages = newMessages;

            renderThreads(messages);

            const newScrollHeight = dom.messagesContainer.scrollHeight;
            dom.messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;
            
            isLoadingMoreMessages = false;
        }


        function renderThreads(messagesToRender) {
            const threads = new Map();
            messagesToRender.forEach(msg => {
                if (!msg.createdAt) return; 
                const threadId = msg.threadId || msg.id;
                if (!threads.has(threadId)) {
                    threads.set(threadId, []);
                }
                threads.get(threadId).push(msg);
            });

            const sortedThreads = [];
            threads.forEach((threadMessages, threadId) => {
                const mainMessage = threadMessages.find(m => m.id === threadId);
                if (mainMessage) {
                    const replies = threadMessages.filter(m => m.id !== threadId).sort((a,b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                    sortedThreads.push({ mainMessage, replies });
                }
            });

            sortedThreads.sort((a, b) => a.mainMessage.createdAt.toMillis() - b.mainMessage.createdAt.toMillis());
            
            const messagesHTML = sortedThreads.map(({ mainMessage, replies }) => {
                return `
                    <div class="message-group" id="thread-group-${mainMessage.id}">
                        ${renderMessage(mainMessage)}
                        ${replies.length > 0 ? `
                            <div class="thread-container mt-2 space-y-4">
                                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                                    <span class="font-medium">${replies.length} ${replies.length > 1 ? 'replies' : 'reply'}</span>
                                </div>
                                ${replies.map(reply => renderMessage(reply)).join('')}
                            </div>
                        ` : ''}
                        <div class="reply-form-container pl-12 mt-2 hidden" id="reply-form-${mainMessage.id}">
                           ${createReplyForm(mainMessage.id)}
                        </div>
                    </div>
                `;
            }).join('');

            const currentScrollTop = dom.messagesContainer.scrollTop;
            const currentScrollHeight = dom.messagesContainer.scrollHeight;
            const isAtBottom = currentScrollHeight - currentScrollTop === dom.messagesContainer.clientHeight;
            
            dom.messagesContainer.innerHTML = '';
            dom.messagesContainer.appendChild(dom.messagesLoader);
            dom.messagesContainer.insertAdjacentHTML('beforeend', messagesHTML);
            
            if (!isAtBottom) {
                 dom.messagesContainer.scrollTop = currentScrollTop;
            }
        }

        function renderMessage(message) {
            const isCurrentUser = message.uid === currentUser.uid;
            const expiresAt = message.expiresAt ? `data-expires-at="${message.expiresAt.toDate().toISOString()}"` : '';

            let contentHTML;
            if (message.type === 'gif' || message.type === 'image') {
                contentHTML = `<img src="${message.text}" alt="Sent image" class="message-image mt-1 rounded-lg max-w-xs md:max-w-sm shadow-md cursor-pointer hover:opacity-80 transition" data-src="${message.text}">`;
            } else {
                contentHTML = `<p class="text-sm message-text whitespace-pre-wrap text-gray-800 dark:text-gray-200">${message.text || ''}</p>`;
            }
            
            const editedTimestamp = message.editedAt ? `<span class="italic text-xs opacity-60 ml-2">(edited)</span>` : '';

            let reactionsHTML = '';
            if (message.reactions) {
                const reactionEntries = Object.entries(message.reactions).filter(([_, uids]) => uids && uids.length > 0);
                if (reactionEntries.length > 0) {
                    reactionsHTML = `<div class="flex gap-1.5 mt-2 flex-wrap">`;
                    reactionEntries.forEach(([emoji, uids]) => {
                        const userHasReacted = uids.includes(currentUser.uid);
                        reactionsHTML += `<button class="reaction-chip text-xs px-2 py-0.5 rounded-full border ${userHasReacted ? 'user-reacted' : 'bg-gray-200 dark:bg-gray-700 border-transparent'}" data-message-id="${message.id}" data-emoji="${emoji}">${emoji} ${uids.length}</button>`;
                    });
                    reactionsHTML += '</div>';
                }
            }
            
            const actionsHTML = `
                <div class="message-actions absolute top-0 right-0 -translate-y-1/2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full shadow-sm flex items-center p-0.5">
                    <div class="relative group/picker">
                        <button class="reaction-toggle-button p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" title="Add reaction" data-message-id="${message.id}">
                             <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </div>
                    <button class="reply-button p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" title="Reply to thread" data-thread-id="${message.threadId || message.id}">
                         <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4"></path></svg>
                    </button>
                    ${isCurrentUser ? `
                        ${message.type === 'text' ? `<button class="edit-message-btn p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" title="Edit message" data-message-id="${message.id}" data-text="${encodeURIComponent(message.text || '')}"><svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button>`: ''}
                        <button class="delete-message-btn p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" title="Delete message" data-message-id="${message.id}"><svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    ` : ''}
                </div>
            `;

            return `
            <div class="message flex gap-3 group" id="msg-${message.id}" data-uid="${message.uid}" ${expiresAt}>
                <img src="${getEffectivePhotoURL({ uid: message.uid, displayName: message.displayName, photoURL: message.photoURL })}" alt="Avatar" class="w-9 h-9 rounded-full shadow-sm shrink-0">
                <div class="flex-1">
                    <div class="relative inline-block">
                        <div class="flex items-center gap-2">
                            <p class="font-bold text-sm text-gray-900 dark:text-white">${message.displayName || 'User'}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${message.createdAt ? message.createdAt.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Sending...'}</p>
                            ${editedTimestamp}
                        </div>
                        ${contentHTML}
                        ${reactionsHTML}
                        ${actionsHTML}
                    </div>
                </div>
            </div>`;
        }

        function createReplyForm(threadId) {
            return `
                <form class="reply-form flex items-start space-x-3" data-thread-id="${threadId}">
                    <img src="${getEffectivePhotoURL(currentUser)}" class="w-8 h-8 rounded-full shrink-0" alt="Your avatar">
                    <div class="flex-1">
                        <div class="border border-gray-300 dark:border-gray-600 rounded-lg focus-within:ring-2 focus-within:ring-primary-500 bg-white dark:bg-gray-800">
                            <textarea name="reply-input" placeholder="Reply to thread..." class="w-full p-2 bg-transparent text-gray-800 dark:text-white focus:outline-none resize-none text-sm" rows="1"></textarea>
                        </div>
                        <div class="flex justify-end items-center mt-2 space-x-2">
                            <button type="button" class="cancel-reply-btn text-xs font-bold text-gray-600 dark:text-gray-400 hover:underline">Cancel</button>
                            <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white text-xs font-bold py-1.5 px-4 rounded-full transition">Send</button>
                        </div>
                    </div>
                </form>
            `;
        }

        function checkExpiredMessages(roomId) {
            document.querySelectorAll('.message[data-expires-at]').forEach(el => {
                if (new Date() > new Date(el.dataset.expiresAt)) {
                    el.classList.add('fading-out');
                    setTimeout(() => {
                        const group = el.closest('.message-group');
                        el.remove();
                        if (group && group.querySelectorAll('.message').length === 0) {
                            group.remove();
                        }
                    }, 300);
                    deleteDoc(doc(db, 'rooms', roomId, 'messages', el.id.replace('msg-', ''))).catch(console.error);
                }
            });
        }
        
        async function sendMessage(text, type, threadId = null) {
            if (!currentRoomId || !text) return;
            
            const messageData = {
                uid: currentUser.uid, 
                displayName: currentUser.displayName, 
                photoURL: getEffectivePhotoURL(currentUser),
                text: text, 
                createdAt: serverTimestamp(),
                expiresAt: threadId ? null : (parseInt(dom.timerSelect.value) > 0 ? Timestamp.fromDate(new Date(Date.now() + parseInt(dom.timerSelect.value))) : null),
                type: type, 
                reactions: {}
            };

            if (threadId) {
                messageData.threadId = threadId;
            }

            const messageRef = await addDoc(collection(db, 'rooms', currentRoomId, 'messages'), messageData);

            if (!threadId) {
                await updateDoc(messageRef, { threadId: messageRef.id });
            }
        }
        
        async function toggleReaction(messageId, emoji) {
            if (!currentRoomId || !currentUser) return;
            const messageRef = doc(db, 'rooms', currentRoomId, 'messages', messageId);

            try {
                const messageSnap = await getDoc(messageRef);
                if (!messageSnap.exists()) {
                    console.error("Message does not exist!");
                    return;
                }

                const reactions = messageSnap.data().reactions || {};
                const uids = reactions[emoji] || [];
                const userIndex = uids.indexOf(currentUser.uid);

                if (userIndex > -1) {
                    uids.splice(userIndex, 1);
                } else {
                    uids.push(currentUser.uid);
                }

                if (uids.length === 0) {
                    delete reactions[emoji];
                } else {
                    reactions[emoji] = uids;
                }

                await updateDoc(messageRef, {
                    reactions: reactions
                });

            } catch (error) {
                console.error("Error toggling reaction: ", error);
            }
        }
        
        // --- GIPHY & IMAGE LOGIC ---
        async function showGiphyModal(threadId = null) {
            const content = `<input id="giphy-search-input" type="text" placeholder="Search for GIFs..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg mb-4 bg-white dark:bg-gray-800 text-gray-800 dark:text-white">
                             <div id="giphy-results" class="grid grid-cols-2 gap-2 h-64 overflow-y-auto scrollable-content"></div>`;
            const modal = createModal('giphy-modal', 'Search GIFs', content, 'Close');
            modal.querySelector('.modal-save').addEventListener('click', () => modal.remove());
            modal.classList.remove('hidden');

            const searchInput = modal.querySelector('#giphy-search-input');
            const resultsContainer = modal.querySelector('#giphy-results');

            const searchGiphy = async (term) => {
                resultsContainer.innerHTML = '<div class="col-span-2 spinner mx-auto"></div>';
                try {
                    const response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(term)}&limit=20&rating=g`);
                    const json = await response.json();
                    resultsContainer.innerHTML = json.data.map(gif => `<img src="${gif.images.fixed_height_small.url}" data-full-url="${gif.images.original.url}" class="cursor-pointer hover:opacity-75 rounded-md">`).join('');
                } catch (error) {
                    resultsContainer.innerHTML = '<p class="text-red-500">Could not fetch GIFs.</p>';
                }
            };
            
            searchInput.addEventListener('input', () => {
                const term = searchInput.value.trim();
                if (term) searchGiphy(term);
            });

            resultsContainer.addEventListener('click', e => {
                if (e.target.tagName === 'IMG') {
                    sendMessage(e.target.dataset.fullUrl, 'gif', threadId);
                    modal.remove();
                }
            });
        }

        async function uploadAndSendImage(file, threadId = null) {
            if (!file) return;

            const submitBtn = threadId ? document.querySelector(`.reply-form[data-thread-id="${threadId}"] button[type="submit"]`) : dom.submitButton;
            const originalContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner-small"></div>';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();

                if (result.success) {
                    await sendMessage(result.data.url, 'image', threadId);
                } else {
                    alert('Image upload failed. Please try again.');
                }
            } catch (error) {
                alert('An error occurred during image upload.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
                dom.imageInput.value = ''; // Reset file input
            }
        }

        function showReactionPicker(messageId, targetElement) {
            let picker = document.getElementById('reaction-picker-global');
            if (!picker) {
                picker = document.createElement('div');
                picker.id = 'reaction-picker-global';
                picker.className = 'fixed z-30 flex gap-1 bg-white dark:bg-gray-800 p-1.5 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 opacity-0 transition-opacity pointer-events-none';
                picker.innerHTML = AVAILABLE_REACTIONS.map(emoji => `<button class="reaction-picker-emoji p-1 text-xl hover:scale-125 transition-transform">${emoji}</button>`).join('');
                document.body.appendChild(picker);

                picker.addEventListener('click', (e) => {
                    const btn = e.target.closest('.reaction-picker-emoji');
                    if (btn) {
                        toggleReaction(picker.dataset.messageId, btn.textContent);
                        hideReactionPicker(true);
                    }
                });
                
                picker.addEventListener('mouseenter', () => clearTimeout(picker.hideTimeout));
                picker.addEventListener('mouseleave', () => hideReactionPicker());
            }

            clearTimeout(picker.hideTimeout);
            const rect = targetElement.getBoundingClientRect();
            picker.style.top = `${rect.top - picker.offsetHeight - 5}px`;
            picker.style.left = `${rect.left}px`;
            picker.dataset.messageId = messageId;
            picker.classList.remove('opacity-0', 'pointer-events-none');
        }

        function hideReactionPicker(immediate = false) {
            let picker = document.getElementById('reaction-picker-global');
            if (picker) {
                clearTimeout(picker.hideTimeout);
                if(immediate) {
                    picker.classList.add('opacity-0', 'pointer-events-none');
                } else {
                    picker.hideTimeout = setTimeout(() => {
                        picker.classList.add('opacity-0', 'pointer-events-none');
                    }, 500);
                }
            }
        }

        // --- INITIALIZE APP ---
        function initApp() {
            dom.loginButton.addEventListener('click', () => signInWithPopup(auth, provider).catch(console.error));
            dom.lobbyLogoutButton.addEventListener('click', () => signOut(auth).catch(console.error));
            dom.backToLobbyButton.addEventListener('click', showLobby);

            dom.messagesContainer.addEventListener('scroll', () => {
                if (dom.messagesContainer.scrollTop === 0) {
                    loadMoreMessages(currentRoomId);
                }
            });

            dom.createRoomButton.addEventListener('click', () => {
                const modal = createModal('create-room-modal', 'Create New Room', 
                    `<input id="new-room-name-input" type="text" placeholder="Enter room name" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white">`
                );
                modal.querySelector('.modal-save').addEventListener('click', async () => {
                    const roomName = modal.querySelector('#new-room-name-input').value.trim();
                    if (roomName) {
                        const newRoomRef = await addDoc(collection(db, 'rooms'), { name: roomName, admin: currentUser.uid, members: [currentUser.uid], pendingRequests: [] });
                        enterRoom(newRoomRef.id);
                    }
                    modal.remove();
                });
                modal.classList.remove('hidden');
            });

            dom.messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = dom.messageInput.value.trim();
                if (!text) return;

                dom.submitButton.disabled = true;
                let textToSend = text;
                if (isTranslateEnabled) {
                    translateText(text).then(translated => {
                        sendMessage(translated, 'text');
                    }).catch(() => {
                        sendMessage(text, 'text');
                    }).finally(() => {
                        dom.messageInput.value = '';
                        dom.messageInput.style.height = 'auto';
                        dom.submitButton.disabled = false;
                    });
                } else {
                    sendMessage(text, 'text').then(() => {
                        dom.messageInput.value = '';
                        dom.messageInput.style.height = 'auto';
                        dom.submitButton.disabled = false;
                    });
                }
            });

            dom.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.altKey) {
                    e.preventDefault();
                    dom.messageForm.requestSubmit();
                }
            });

            dom.messageInput.addEventListener('input', () => {
                dom.messageInput.style.height = 'auto';
                dom.messageInput.style.height = `${dom.messageInput.scrollHeight}px`;
            });

            dom.messagesContainer.addEventListener('mouseover', (e) => {
                const reactionToggleBtn = e.target.closest('.reaction-toggle-button');
                if (reactionToggleBtn) {
                   showReactionPicker(reactionToggleBtn.dataset.messageId, reactionToggleBtn);
                }
            });
            dom.messagesContainer.addEventListener('mouseout', (e) => {
                const reactionToggleBtn = e.target.closest('.reaction-toggle-button');
                if (reactionToggleBtn) {
                   hideReactionPicker();
                }
            });


            dom.messagesContainer.addEventListener('click', async (e) => {
                const replyBtn = e.target.closest('.reply-button');
                if (replyBtn) {
                    const threadId = replyBtn.dataset.threadId;
                    const replyFormContainer = document.getElementById(`reply-form-${threadId}`);
                    if (replyFormContainer) {
                        replyFormContainer.classList.toggle('hidden');
                        if (!replyFormContainer.classList.contains('hidden')) {
                            replyFormContainer.querySelector('textarea').focus();
                        }
                    }
                }

                const reactionBtn = e.target.closest('.reaction-chip');
                if (reactionBtn) {
                    toggleReaction(reactionBtn.dataset.messageId, reactionBtn.dataset.emoji);
                }
                
                const editMsgBtn = e.target.closest('.edit-message-btn');
                if (editMsgBtn) {
                    const modal = createModal('edit-message-modal', 'Edit Message', `<textarea id="edit-message-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white" rows="4"></textarea>`, 'Save Changes');
                    modal.querySelector('#edit-message-input').value = decodeURIComponent(editMsgBtn.dataset.text);
                    
                    modal.querySelector('.modal-save').addEventListener('click', async () => {
                        const newText = modal.querySelector('#edit-message-input').value.trim();
                        if (newText) {
                            await updateDoc(doc(db, 'rooms', currentRoomId, 'messages', editMsgBtn.dataset.messageId), { text: newText, editedAt: serverTimestamp() });
                        }
                        modal.remove();
                    });
                    modal.classList.remove('hidden');
                }

                const deleteMsgBtn = e.target.closest('.delete-message-btn');
                if (deleteMsgBtn) {
                    const modal = createModal('delete-message-modal', 'Delete Message?', `<p class="text-gray-600 dark:text-gray-300">Are you sure you want to delete this message? This cannot be undone.</p>`, 'Delete Forever');
                    modal.querySelector('.modal-save').classList.replace('bg-primary-600', 'bg-red-600');
                    modal.querySelector('.modal-save').addEventListener('click', async () => {
                        await deleteDoc(doc(db, 'rooms', currentRoomId, 'messages', deleteMsgBtn.dataset.messageId));
                        modal.remove();
                    });
                    modal.classList.remove('hidden');
                }

                const image = e.target.closest('.message-image');
                if (image) showImageModal(image.dataset.src);

                const cancelReplyBtn = e.target.closest('.cancel-reply-btn');
                if (cancelReplyBtn) {
                    cancelReplyBtn.closest('.reply-form-container').classList.add('hidden');
                }
            });
            
            dom.messagesContainer.addEventListener('keydown', (e) => {
                if (e.target.matches('.reply-form textarea')) {
                    if (e.key === 'Enter' && !e.shiftKey && !e.altKey) {
                        e.preventDefault();
                        e.target.closest('form').requestSubmit();
                    }
                    if (e.key === 'Escape') {
                        e.target.closest('.reply-form-container').classList.add('hidden');
                    }
                }
            });

            dom.messagesContainer.addEventListener('submit', async (e) => {
                if (e.target.classList.contains('reply-form')) {
                    e.preventDefault();
                    const form = e.target;
                    const threadId = form.dataset.threadId;
                    const input = form.querySelector('textarea[name="reply-input"]');
                    const text = input.value.trim();
                    if (!text) return;
                    await sendMessage(text, 'text', threadId);
                    input.value = '';
                    input.style.height = 'auto';
                }
            });

            document.addEventListener('click', e => {
                const picker = document.getElementById('reaction-picker-global');
                if (picker && !picker.contains(e.target) && !e.target.closest('.reaction-toggle-button')) {
                   hideReactionPicker(true);
                }

                const enterBtn = e.target.closest('.enter-room-btn');
                if (enterBtn) enterRoom(enterBtn.dataset.id);
                
                const requestBtn = e.target.closest('.request-join-btn');
                if (requestBtn) {
                    updateDoc(doc(db, 'rooms', requestBtn.dataset.id), { 
                        pendingRequests: arrayUnion({ uid: currentUser.uid, displayName: currentUser.displayName, photoURL: currentUser.photoURL }) 
                    });
                }
                
                const deleteRoomBtn = e.target.closest('.delete-room-btn');
                if (deleteRoomBtn) {
                    const modal = createModal('delete-room-modal', 'Are you sure?', `<p class="text-gray-600 dark:text-gray-300 mb-4">This will permanently delete the <strong>${deleteRoomBtn.dataset.name}</strong> room and all its messages. This action cannot be undone.</p>`, 'Delete Forever');
                    modal.querySelector('.modal-save').classList.replace('bg-primary-600', 'bg-red-600');
                    modal.querySelector('.modal-save').addEventListener('click', async () => {
                        await deleteRoom(deleteRoomBtn.dataset.id);
                        modal.remove();
                    });
                    modal.classList.remove('hidden');
                }
            });

            dom.editRoomNameButton.addEventListener('click', () => {
                const modal = createModal('room-name-modal', 'Change Room Name', 
                    `<input id="new-room-name-input" type="text" value="${dom.roomNameElement.textContent}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white">`
                );
                modal.querySelector('.modal-save').addEventListener('click', async () => {
                    const newName = modal.querySelector('#new-room-name-input').value.trim();
                    if (newName && currentRoomId) await updateDoc(doc(db, 'rooms', currentRoomId), { name: newName });
                    modal.remove();
                });
                modal.classList.remove('hidden');
            });

            dom.editUserProfileButton.addEventListener('click', showEditProfileModal);

            dom.manageRequestsButton.addEventListener('click', async () => {
                const roomSnap = await getDoc(doc(db, 'rooms', currentRoomId));
                const requests = roomSnap.data().pendingRequests || [];
                let requestsHTML = requests.length === 0 ? `<p class="text-gray-500 dark:text-gray-400">No pending requests.</p>` :
                    requests.map(req => `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img src="${req.photoURL || `https://ui-avatars.com/api/?name=${req.displayName}`}" class="w-10 h-10 rounded-full">
                                <span class="font-medium text-gray-800 dark:text-white">${req.displayName}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="approve-request-btn bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-semibold" data-uid="${req.uid}">Approve</button>
                                <button class="deny-request-btn bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-semibold" data-uid="${req.uid}">Deny</button>
                            </div>
                        </div>`).join('');

                const modal = createModal('requests-modal', 'Membership Requests', `<div class="space-y-4 max-h-96 overflow-y-auto scrollable-content">${requestsHTML}</div>`);
                modal.querySelector('.modal-save').style.display = 'none';
                modal.classList.remove('hidden');

                modal.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.approve-request-btn, .deny-request-btn');
                    if (!btn) return;
                    const roomRef = doc(db, 'rooms', currentRoomId);
                    const roomSnap = await getDoc(roomRef);
                    const requestData = (roomSnap.data().pendingRequests || []).find(r => r.uid === btn.dataset.uid);
                    if (requestData) {
                        const updates = { pendingRequests: arrayRemove(requestData) };
                        if (btn.classList.contains('approve-request-btn')) updates.members = arrayUnion(btn.dataset.uid);
                        await updateDoc(roomRef, updates);
                    }
                    modal.remove();
                });
            });

            dom.themeToggle.addEventListener('click', () => {
                dom.html.classList.toggle('dark');
                localStorage.setItem('theme', dom.html.classList.contains('dark') ? 'dark' : 'light');
                updateThemeIcon();
            });

            dom.notificationToggle.addEventListener('click', () => {
                areNotificationsEnabled = !areNotificationsEnabled;
                localStorage.setItem('notificationsEnabled', areNotificationsEnabled);
                updateNotificationToggleButton();
                if (areNotificationsEnabled) requestNotificationPermission();
            });

            dom.translateToggle.addEventListener('click', () => {
                isTranslateEnabled = !isTranslateEnabled;
                localStorage.setItem('translateEnabled', isTranslateEnabled);
                updateTranslateButton();
            });

            if (localStorage.getItem('theme') === 'dark') dom.html.classList.add('dark');
            updateThemeIcon();
            updateNotificationToggleButton();
            updateTranslateButton();

            dom.giphyButton.addEventListener('click', () => showGiphyModal());
            dom.imageUploadButton.addEventListener('click', () => dom.imageInput.click());
            dom.imageInput.addEventListener('change', (e) => uploadAndSendImage(e.target.files[0]));
        }

        initApp();
    </script>
</body>
</html>
